{
 "Description": "Career Doomsday Clock â€” Bedrock Agent and Knowledge Base",
 "Resources": {
  "KnowledgeBaseRoleA2B317B9": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "bedrock.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Description": "Bedrock Knowledge Base execution role"
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/KnowledgeBaseRole/Resource"
   }
  },
  "KnowledgeBaseRoleDefaultPolicyB3F66209": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "s3:GetObject*",
        "s3:GetBucket*",
        "s3:List*"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::ImportValue": "CareerDoomsdayStorageStack:ExportsOutputFnGetAttKnowledgeBaseBucketC011DD60Arn95976433"
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::ImportValue": "CareerDoomsdayStorageStack:ExportsOutputFnGetAttKnowledgeBaseBucketC011DD60Arn95976433"
           },
           "/*"
          ]
         ]
        }
       ]
      },
      {
       "Action": "bedrock:InvokeModel",
       "Effect": "Allow",
       "Resource": {
        "Fn::Join": [
         "",
         [
          "arn:aws:bedrock:",
          {
           "Ref": "AWS::Region"
          },
          "::foundation-model/amazon.titan-embed-text-v2:0"
         ]
        ]
       }
      },
      {
       "Action": "aoss:APIAccessAll",
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "KnowledgeBaseRoleDefaultPolicyB3F66209",
    "Roles": [
     {
      "Ref": "KnowledgeBaseRoleA2B317B9"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/KnowledgeBaseRole/DefaultPolicy/Resource"
   }
  },
  "EncryptionPolicy": {
   "Type": "AWS::OpenSearchServerless::SecurityPolicy",
   "Properties": {
    "Name": "career-doomsday-enc",
    "Policy": "{\"Rules\":[{\"ResourceType\":\"collection\",\"Resource\":[\"collection/career-doomsday-kb\"]}],\"AWSOwnedKey\":true}",
    "Type": "encryption"
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/EncryptionPolicy"
   }
  },
  "NetworkPolicy": {
   "Type": "AWS::OpenSearchServerless::SecurityPolicy",
   "Properties": {
    "Name": "career-doomsday-net",
    "Policy": "[{\"Rules\":[{\"ResourceType\":\"collection\",\"Resource\":[\"collection/career-doomsday-kb\"]},{\"ResourceType\":\"dashboard\",\"Resource\":[\"collection/career-doomsday-kb\"]}],\"AllowFromPublic\":true}]",
    "Type": "network"
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/NetworkPolicy"
   }
  },
  "KBCollection": {
   "Type": "AWS::OpenSearchServerless::Collection",
   "Properties": {
    "Description": "Career Doomsday Clock KB vector store",
    "Name": "career-doomsday-kb",
    "Type": "VECTORSEARCH"
   },
   "DependsOn": [
    "EncryptionPolicy",
    "NetworkPolicy"
   ],
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/KBCollection"
   }
  },
  "DataAccessPolicy": {
   "Type": "AWS::OpenSearchServerless::AccessPolicy",
   "Properties": {
    "Name": "career-doomsday-access",
    "Policy": {
     "Fn::Join": [
      "",
      [
       "[{\"Rules\":[{\"ResourceType\":\"index\",\"Resource\":[\"index/career-doomsday-kb/*\"],\"Permission\":[\"aoss:CreateIndex\",\"aoss:UpdateIndex\",\"aoss:DescribeIndex\",\"aoss:ReadDocument\",\"aoss:WriteDocument\"]},{\"ResourceType\":\"collection\",\"Resource\":[\"collection/career-doomsday-kb\"],\"Permission\":[\"aoss:CreateCollectionItems\",\"aoss:UpdateCollectionItems\",\"aoss:DescribeCollectionItems\"]}],\"Principal\":[\"",
       {
        "Fn::GetAtt": [
         "KnowledgeBaseRoleA2B317B9",
         "Arn"
        ]
       },
       "\"]}]"
      ]
     ]
    },
    "Type": "data"
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/DataAccessPolicy"
   }
  },
  "CareerKnowledgeBase": {
   "Type": "AWS::Bedrock::KnowledgeBase",
   "Properties": {
    "Description": "Future of Jobs Report 2025 career analysis KB",
    "KnowledgeBaseConfiguration": {
     "Type": "VECTOR",
     "VectorKnowledgeBaseConfiguration": {
      "EmbeddingModelArn": {
       "Fn::Join": [
        "",
        [
         "arn:aws:bedrock:",
         {
          "Ref": "AWS::Region"
         },
         "::foundation-model/amazon.titan-embed-text-v2:0"
        ]
       ]
      }
     }
    },
    "Name": "career-doomsday-kb",
    "RoleArn": {
     "Fn::GetAtt": [
      "KnowledgeBaseRoleA2B317B9",
      "Arn"
     ]
    },
    "StorageConfiguration": {
     "OpensearchServerlessConfiguration": {
      "CollectionArn": {
       "Fn::GetAtt": [
        "KBCollection",
        "Arn"
       ]
      },
      "FieldMapping": {
       "MetadataField": "metadata",
       "TextField": "text",
       "VectorField": "embedding"
      },
      "VectorIndexName": "career-doomsday-index"
     },
     "Type": "OPENSEARCH_SERVERLESS"
    }
   },
   "DependsOn": [
    "KBCollection"
   ],
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/CareerKnowledgeBase"
   }
  },
  "KBDataSource": {
   "Type": "AWS::Bedrock::DataSource",
   "Properties": {
    "DataSourceConfiguration": {
     "S3Configuration": {
      "BucketArn": {
       "Fn::ImportValue": "CareerDoomsdayStorageStack:ExportsOutputFnGetAttKnowledgeBaseBucketC011DD60Arn95976433"
      },
      "InclusionPrefixes": [
       "pdfdata/"
      ]
     },
     "Type": "S3"
    },
    "Description": "Future of Jobs Report PDF files from pdfdata/",
    "KnowledgeBaseId": {
     "Fn::GetAtt": [
      "CareerKnowledgeBase",
      "KnowledgeBaseId"
     ]
    },
    "Name": "career-doomsday-pdf-source"
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/KBDataSource"
   }
  },
  "AgentRoleF4A42D6B": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "bedrock.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Description": "Bedrock Agent execution role"
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/AgentRole/Resource"
   }
  },
  "AgentRoleDefaultPolicy1027F5D2": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "bedrock:InvokeModel",
       "Effect": "Allow",
       "Resource": {
        "Fn::Join": [
         "",
         [
          "arn:aws:bedrock:",
          {
           "Ref": "AWS::Region"
          },
          "::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0"
         ]
        ]
       }
      },
      {
       "Action": "bedrock:Retrieve",
       "Effect": "Allow",
       "Resource": {
        "Fn::Join": [
         "",
         [
          "arn:aws:bedrock:",
          {
           "Ref": "AWS::Region"
          },
          ":",
          {
           "Ref": "AWS::AccountId"
          },
          ":knowledge-base/*"
         ]
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "AgentRoleDefaultPolicy1027F5D2",
    "Roles": [
     {
      "Ref": "AgentRoleF4A42D6B"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/AgentRole/DefaultPolicy/Resource"
   }
  },
  "CareerDoomsdayAgent": {
   "Type": "AWS::Bedrock::Agent",
   "Properties": {
    "AgentName": "career-doomsday-agent",
    "AgentResourceRoleArn": {
     "Fn::GetAtt": [
      "AgentRoleF4A42D6B",
      "Arn"
     ]
    },
    "Description": "AI Agent that analyzes career lifespan and suggests new careers",
    "FoundationModel": "anthropic.claude-3-5-sonnet-20241022-v2:0",
    "IdleSessionTTLInSeconds": 600,
    "Instruction": "You are a dystopian career analysis AI.\nAnalyze the user's current job, strengths, and hobbies to:\n1. Evaluate AI replacement risk per skill (probability%, time horizon, justification)\n2. Suggest 3 new careers combining current job + strengths + hobbies\n3. Provide a transition roadmap for each new career\n\nUse the Future of Jobs Report 2025 data from the Knowledge Base as evidence.\nWrite all responses in Korean with a dystopian worldview tone.\nRespond ONLY in the specified JSON format.",
    "KnowledgeBases": [
     {
      "Description": "Future of Jobs Report 2025 career trend data",
      "KnowledgeBaseId": {
       "Fn::GetAtt": [
        "CareerKnowledgeBase",
        "KnowledgeBaseId"
       ]
      },
      "KnowledgeBaseState": "ENABLED"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/CareerDoomsdayAgent"
   }
  },
  "CareerDoomsdayAgentAlias": {
   "Type": "AWS::Bedrock::AgentAlias",
   "Properties": {
    "AgentAliasName": "prod",
    "AgentId": {
     "Fn::GetAtt": [
      "CareerDoomsdayAgent",
      "AgentId"
     ]
    },
    "Description": "Production Agent Alias"
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/CareerDoomsdayAgentAlias"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/0WNQa6CQBBEz+IeWkUvwMedC40cwLRNqy3jtJmekRjC3Q0Yv6uqt3hVBRTrBSxm2FlOTZs7OUFfR6Q2w86OveAd+oM6zqqzn3KvTug14qcNmT7YG2Ogq3F4cnBsBn119jVTChJfP6VS55iiqB+pJGKz78yJm6DUTubWa+e4ufAf2nS9wYi1pkATlRf28b+UTtCGYeRdio8Uh8xrw3Cz+bNYw3IFy9nNRPKQfJQ7w+GTb007Hk/8AAAA"
   },
   "Metadata": {
    "aws:cdk:path": "CareerDoomsdayBedrockStack/CDKMetadata/Default"
   },
   "Condition": "CDKMetadataAvailable"
  }
 },
 "Outputs": {
  "BedrockAgentId": {
   "Description": "Bedrock Agent ID",
   "Value": {
    "Fn::GetAtt": [
     "CareerDoomsdayAgent",
     "AgentId"
    ]
   }
  },
  "BedrockAgentAliasId": {
   "Description": "Bedrock Agent Alias ID",
   "Value": {
    "Fn::GetAtt": [
     "CareerDoomsdayAgentAlias",
     "AgentAliasId"
    ]
   }
  },
  "KnowledgeBaseId": {
   "Description": "Knowledge Base ID",
   "Value": {
    "Fn::GetAtt": [
     "CareerKnowledgeBase",
     "KnowledgeBaseId"
    ]
   }
  },
  "ExportsOutputFnGetAttCareerDoomsdayAgentAgentIdC8E05492": {
   "Value": {
    "Fn::GetAtt": [
     "CareerDoomsdayAgent",
     "AgentId"
    ]
   },
   "Export": {
    "Name": "CareerDoomsdayBedrockStack:ExportsOutputFnGetAttCareerDoomsdayAgentAgentIdC8E05492"
   }
  },
  "ExportsOutputFnGetAttCareerDoomsdayAgentAliasAgentAliasId5554EDD1": {
   "Value": {
    "Fn::GetAtt": [
     "CareerDoomsdayAgentAlias",
     "AgentAliasId"
    ]
   },
   "Export": {
    "Name": "CareerDoomsdayBedrockStack:ExportsOutputFnGetAttCareerDoomsdayAgentAliasAgentAliasId5554EDD1"
   }
  }
 },
 "Conditions": {
  "CDKMetadataAvailable": {
   "Fn::Or": [
    {
     "Fn::Or": [
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "af-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-east-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-northeast-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-northeast-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-northeast-3"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-south-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-southeast-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-southeast-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-southeast-3"
       ]
      }
     ]
    },
    {
     "Fn::Or": [
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-southeast-4"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ca-central-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ca-west-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "cn-north-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "cn-northwest-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-central-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-central-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-north-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-south-2"
       ]
      }
     ]
    },
    {
     "Fn::Or": [
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-west-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-west-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-west-3"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "il-central-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "me-central-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "me-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "sa-east-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-east-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-east-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-west-1"
       ]
      }
     ]
    },
    {
     "Fn::Equals": [
      {
       "Ref": "AWS::Region"
      },
      "us-west-2"
     ]
    }
   ]
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}